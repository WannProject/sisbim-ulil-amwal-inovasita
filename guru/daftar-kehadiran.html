<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daftar Kehadiran Siswa - SISBIM MA Ulil Amwal</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <style>
      .btn-primary {
        background: linear-gradient(135deg, #006a67, #004d4a) !important;
        border: none !important;
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #004d4a, #006a67) !important;
      }
      .text-primary {
        color: #006a67 !important;
      }
      .bg-primary {
        background-color: #006a67 !important;
      }
      .badge-hadir {
        background-color: #28a745;
      }
      .badge-izin {
        background-color: #ffc107;
      }
      .badge-sakit {
        background-color: #17a2b8;
      }
      .badge-alpha {
        background-color: #dc3545;
      }
      .filter-section {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .table-container {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status-summary {
        background: linear-gradient(135deg, #006a67, #004d4a);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }
      .summary-card {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .summary-card h3 {
        margin: 0;
        font-size: 2rem;
        font-weight: bold;
      }
      .summary-card p {
        margin: 5px 0 0 0;
        font-size: 0.9rem;
        opacity: 0.9;
      }
      .checkbox-cell {
        width: 50px;
        text-align: center;
      }
      .action-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <img
          src="../assets/img/logo.jpg"
          alt="MA Ulil Amwal Logo"
          class="sidebar-logo"
        />
        <h4>SISBIM</h4>
        <p>MA Ulil Amwal</p>
      </div>
      <div class="sidebar-menu">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="daftar-kehadiran.html">
              <i class="fas fa-clipboard-check"></i>
              <span>Daftar Kehadiran</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="input-nilai.html">
              <i class="fas fa-edit"></i>
              <span>Input Nilai</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="data-siswa.html">
              <i class="fas fa-user-graduate"></i>
              <span>Data Siswa</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="rekap-nilai.html">
              <i class="fas fa-chart-bar"></i>
              <span>Rekap Nilai</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="cetak-laporan.html">
              <i class="fas fa-print"></i>
              <span>Cetak Laporan</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="jadwal-mengajar.html">
              <i class="fas fa-calendar-alt"></i>
              <span>Jadwal Mengajar</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="profil.html">
              <i class="fas fa-user"></i>
              <span>Profil</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Navigation -->
      <nav class="top-navbar">
        <div class="d-flex align-items-center">
          <button class="btn btn-link text-dark me-3" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </button>
          <h4 class="mb-0">Daftar Kehadiran Siswa</h4>
        </div>
        <div class="d-flex align-items-center">
          <span class="me-3" data-user-info="username">Guru</span>
          <button class="btn btn-outline-danger btn-sm" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </nav>

      <!-- Dashboard Content -->
      <div class="container-fluid p-4">
        <!-- Info Absensi Hari Ini -->
        <div class="filter-section">
          <h5 class="mb-3">
            <i class="fas fa-info-circle"></i> Informasi Absensi
          </h5>
          <div class="row">
            <div class="col-md-2 mb-3">
              <label class="form-label">Tanggal</label>
              <input
                type="date"
                class="form-control"
                id="tanggalAbsen"
                value="2025-10-08"
                readonly
              />
            </div>
            <div class="col-md-2 mb-3">
              <label class="form-label">Hari</label>
              <input
                type="text"
                class="form-control"
                id="hariAbsen"
                value="Selasa"
                readonly
              />
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label"
                ><span class="text-danger">*</span> Kelas</label
              >
              <select class="form-select" id="kelasAbsen" required>
                <option value="">-- Pilih Kelas --</option>
                <option value="X IPA 1">X IPA 1</option>
                <option value="X IPA 2">X IPA 2</option>
                <option value="X IPS 1">X IPS 1</option>
                <option value="XI IPA 1">XI IPA 1</option>
                <option value="XI IPA 2">XI IPA 2</option>
                <option value="XI IPS 1">XI IPS 1</option>
                <option value="XII IPA 1">XII IPA 1</option>
                <option value="XII IPA 2">XII IPA 2</option>
                <option value="XII IPS 1">XII IPS 1</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label"
                ><span class="text-danger">*</span> Mata Pelajaran</label
              >
              <select class="form-select" id="mataPelajaran" required>
                <option value="">-- Pilih Mapel --</option>
                <option value="Matematika">Matematika</option>
                <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                <option value="Bahasa Inggris">Bahasa Inggris</option>
                <option value="Fisika">Fisika</option>
                <option value="Kimia">Kimia</option>
                <option value="Biologi">Biologi</option>
                <option value="Sejarah">Sejarah</option>
                <option value="Geografi">Geografi</option>
                <option value="Ekonomi">Ekonomi</option>
                <option value="Sosiologi">Sosiologi</option>
                <option value="Pendidikan Agama">Pendidikan Agama</option>
                <option value="PJOK">PJOK</option>
              </select>
            </div>
            <div class="col-md-2 mb-3">
              <label class="form-label"
                ><span class="text-danger">*</span> Jam Ke</label
              >
              <select class="form-select" id="jamKe" required>
                <option value="">-- Pilih --</option>
                <option value="1">Jam 1</option>
                <option value="2">Jam 2</option>
                <option value="3">Jam 3</option>
                <option value="4">Jam 4</option>
                <option value="5">Jam 5</option>
                <option value="6">Jam 6</option>
                <option value="7">Jam 7</option>
                <option value="8">Jam 8</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary" onclick="muatDataSiswa()">
            <i class="fas fa-users"></i> Muat Daftar Siswa
          </button>
        </div>

        <!-- Status Summary -->
        <div class="status-summary" id="summarySection" style="display: none">
          <div class="row">
            <div class="col-md-3 mb-3 mb-md-0">
              <div class="summary-card">
                <h3 id="totalHadir">0</h3>
                <p><i class="fas fa-check-circle"></i> Hadir</p>
              </div>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
              <div class="summary-card">
                <h3 id="totalIzin">0</h3>
                <p><i class="fas fa-envelope"></i> Izin</p>
              </div>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
              <div class="summary-card">
                <h3 id="totalSakit">0</h3>
                <p><i class="fas fa-notes-medical"></i> Sakit</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="summary-card">
                <h3 id="totalAlpha">0</h3>
                <p><i class="fas fa-times-circle"></i> Alpha</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Table Container -->
        <div class="table-container" id="tableSection" style="display: none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
              <i class="fas fa-list"></i>
              <span id="judulAbsen">Daftar Kehadiran Siswa</span>
            </h5>
            <span class="badge bg-secondary" id="totalSiswa"
              >Total: 0 Siswa</span
            >
          </div>

          <div class="mb-3">
            <input
              type="text"
              class="form-control"
              id="searchSiswa"
              placeholder="🔍 Cari siswa berdasarkan nama atau NIS..."
            />
          </div>

          <div class="table-responsive">
            <table class="table table-hover table-bordered" id="tableKehadiran">
              <thead class="table-dark">
                <tr>
                  <th class="text-dark" style="width: 50px">No</th>
                  <th class="text-dark" style="width: 120px">NIS</th>
                  <th class="text-dark">Nama Siswa</th>
                  <th class="text-dark" style="width: 150px">
                    Status Kehadiran
                  </th>
                  <th class="text-dark" style="width: 100px">Jam Hadir</th>
                  <th class="text-dark" style="width: 250px">Keterangan</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <!-- Data akan diisi oleh JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons mt-3">
            <button class="btn btn-primary btn-lg" onclick="simpanKehadiran()">
              <i class="fas fa-save"></i> Simpan Kehadiran
            </button>
            <button class="btn btn-success" onclick="exportToExcel()">
              <i class="fas fa-file-excel"></i> Export Excel
            </button>
            <button class="btn btn-info text-white" onclick="cetakKehadiran()">
              <i class="fas fa-print"></i> Cetak
            </button>
            <button class="btn btn-secondary" onclick="resetForm()">
              <i class="fas fa-redo"></i> Reset
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Edit Status -->
    <div class="modal fade" id="modalEditStatus" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="fas fa-edit"></i> Ubah Status Kehadiran
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label"><strong>Nama Siswa</strong></label>
              <input type="text" class="form-control" id="editNama" readonly />
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>NIS</strong></label>
              <input type="text" class="form-control" id="editNIS" readonly />
            </div>
            <div class="mb-3">
              <label class="form-label"
                ><strong>Status Kehadiran</strong></label
              >
              <select class="form-select" id="editStatus">
                <option value="Hadir">✅ Hadir</option>
                <option value="Izin">📧 Izin</option>
                <option value="Sakit">🏥 Sakit</option>
                <option value="Alpha">❌ Alpha</option>
              </select>
            </div>
            <div class="mb-3" id="jamHadirGroup">
              <label class="form-label"><strong>Jam Hadir</strong></label>
              <input type="time" class="form-control" id="editJam" />
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Keterangan</strong></label>
              <textarea
                class="form-control"
                id="editKeterangan"
                rows="3"
                placeholder="Masukkan keterangan jika perlu (opsional)"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times"></i> Batal
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateStatus()"
            >
              <i class="fas fa-save"></i> Simpan Perubahan
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      // Data Master Siswa per Kelas (Dummy Data)
      const masterSiswa = {
        "X IPA 1": [
          { nis: "2023001", nama: "Ahmad Fauzi" },
          { nis: "2023002", nama: "Siti Nurhaliza" },
          { nis: "2023003", nama: "Muhammad Rizki" },
          { nis: "2023004", nama: "Dewi Lestari" },
          { nis: "2023005", nama: "Budi Santoso" },
          { nis: "2023006", nama: "Nur Azizah" },
          { nis: "2023007", nama: "Andi Wijaya" },
          { nis: "2023008", nama: "Fitria Rahmawati" },
          { nis: "2023009", nama: "Dimas Pratama" },
          { nis: "2023010", nama: "Rina Safitri" },
          { nis: "2023011", nama: "Arif Setiawan" },
          { nis: "2023012", nama: "Laila Nurhayati" },
          { nis: "2023013", nama: "Rizal Maulana" },
          { nis: "2023014", nama: "Indah Permatasari" },
          { nis: "2023015", nama: "Hendra Gunawan" },
          { nis: "2023016", nama: "Maya Sari" },
          { nis: "2023017", nama: "Yoga Aditya" },
          { nis: "2023018", nama: "Sari Rahayu" },
          { nis: "2023019", nama: "Fahmi Abdullah" },
          { nis: "2023020", nama: "Novi Andriani" },
          { nis: "2023021", nama: "Agus Salim" },
          { nis: "2023022", nama: "Putri Maharani" },
          { nis: "2023023", nama: "Bayu Aji" },
          { nis: "2023024", nama: "Ani Suryani" },
          { nis: "2023025", nama: "Rudi Hermawan" },
          { nis: "2023026", nama: "Lina Marlina" },
          { nis: "2023027", nama: "Irfan Hakim" },
          { nis: "2023028", nama: "Yuni Astuti" },
          { nis: "2023029", nama: "Doni Prasetyo" },
          { nis: "2023030", nama: "Eka Putri" },
          { nis: "2023031", nama: "Taufik Hidayat" },
          { nis: "2023032", nama: "Wulan Dari" },
        ],
        "X IPA 2": [
          { nis: "2023033", nama: "Rina Wijayanti" },
          { nis: "2023034", nama: "Bambang Susilo" },
          { nis: "2023035", nama: "Siska Amelia" },
          { nis: "2023036", nama: "Dedi Kurniawan" },
          { nis: "2023037", nama: "Wati Suryani" },
          // ... tambah data siswa lainnya
        ],
        // Tambahkan kelas lainnya sesuai kebutuhan
      };

      let dataKehadiran = [];
      let currentEditIndex = -1;
      let filteredData = [];

      // Set tanggal hari ini
      function setTanggalHariIni() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const tanggal = `${yyyy}-${mm}-${dd}`;

        document.getElementById("tanggalAbsen").value = tanggal;

        const namaHari = [
          "Minggu",
          "Senin",
          "Selasa",
          "Rabu",
          "Kamis",
          "Jumat",
          "Sabtu",
        ];
        document.getElementById("hariAbsen").value = namaHari[today.getDay()];
      }

      // Muat data siswa berdasarkan kelas yang dipilih
      function muatDataSiswa() {
        const kelas = document.getElementById("kelasAbsen").value;
        const mapel = document.getElementById("mataPelajaran").value;
        const jamKe = document.getElementById("jamKe").value;

        if (!kelas) {
          alert("⚠️ Silakan pilih kelas terlebih dahulu!");
          return;
        }
        if (!mapel) {
          alert("⚠️ Silakan pilih mata pelajaran terlebih dahulu!");
          return;
        }
        if (!jamKe) {
          alert("⚠️ Silakan pilih jam pelajaran terlebih dahulu!");
          return;
        }

        const siswaKelas = masterSiswa[kelas];
        if (!siswaKelas) {
          alert("❌ Data siswa untuk kelas ini belum tersedia!");
          return;
        }

        // Inisialisasi data kehadiran
        dataKehadiran = siswaKelas.map((siswa, index) => ({
          no: index + 1,
          nis: siswa.nis,
          nama: siswa.nama,
          status: "Alpha", // Default semua alpha
          jam: "-",
          keterangan: "-",
        }));

        filteredData = [...dataKehadiran];

        // Update judul
        const tanggal = document.getElementById("tanggalAbsen").value;
        const hari = document.getElementById("hariAbsen").value;
        document.getElementById(
          "judulAbsen"
        ).textContent = `${kelas} - ${mapel} (Jam ${jamKe}) - ${hari}, ${formatTanggal(
          tanggal
        )}`;

        document.getElementById(
          "totalSiswa"
        ).textContent = `Total: ${siswaKelas.length} Siswa`;

        // Tampilkan section
        document.getElementById("summarySection").style.display = "block";
        document.getElementById("tableSection").style.display = "block";

        renderTable();
      }

      // Format tanggal
      function formatTanggal(tanggal) {
        const [y, m, d] = tanggal.split("-");
        const bulan = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "Mei",
          "Jun",
          "Jul",
          "Agt",
          "Sep",
          "Okt",
          "Nov",
          "Des",
        ];
        return `${d} ${bulan[parseInt(m) - 1]} ${y}`;
      }

      // Render table
      function renderTable(data = filteredData) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        if (data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center">Tidak ada data siswa</td></tr>';
          return;
        }

        data.forEach((siswa, index) => {
          const actualIndex = dataKehadiran.findIndex(
            (s) => s.nis === siswa.nis
          );

          const statusOptions = `
            <select class="form-select form-select-sm status-select" 
                    onchange="ubahStatus(${actualIndex}, this.value)" 
                    data-index="${actualIndex}">
              <option value="Alpha" ${
                siswa.status === "Alpha" ? "selected" : ""
              }>❌ Alpha</option>
              <option value="Hadir" ${
                siswa.status === "Hadir" ? "selected" : ""
              }>✅ Hadir</option>
              <option value="Izin" ${
                siswa.status === "Izin" ? "selected" : ""
              }>📧 Izin</option>
              <option value="Sakit" ${
                siswa.status === "Sakit" ? "selected" : ""
              }>🏥 Sakit</option>
            </select>
          `;

          const row = `
            <tr class="${
              siswa.status === "Hadir"
                ? "table-success"
                : siswa.status === "Izin"
                ? "table-warning"
                : siswa.status === "Sakit"
                ? "table-info"
                : "table-danger"
            }">
              <td>${siswa.no}</td>
              <td>${siswa.nis}</td>
              <td><strong>${siswa.nama}</strong></td>
              <td>${statusOptions}</td>
              <td>
                <input type="time" class="form-control form-control-sm" 
                       value="${siswa.jam !== "-" ? siswa.jam : ""}"
                       onchange="updateJam(${actualIndex}, this.value)"
                       ${siswa.status !== "Hadir" ? "disabled" : ""} />
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" 
                       value="${
                         siswa.keterangan !== "-" ? siswa.keterangan : ""
                       }"
                       onchange="updateKeterangan(${actualIndex}, this.value)"
                       placeholder="Keterangan..." />
              </td>
            </tr>
          `;
          tbody.innerHTML += row;
        });

        updateSummary();
      }

      // Ubah status langsung dari dropdown
      function ubahStatus(index, status) {
        dataKehadiran[index].status = status;

        // Set jam otomatis jika hadir
        if (status === "Hadir" && dataKehadiran[index].jam === "-") {
          const now = new Date();
          const jam = String(now.getHours()).padStart(2, "0");
          const menit = String(now.getMinutes()).padStart(2, "0");
          dataKehadiran[index].jam = `${jam}:${menit}`;
        } else if (status !== "Hadir") {
          dataKehadiran[index].jam = "-";
        }

        renderTable();
      }

      // Update jam
      function updateJam(index, jam) {
        dataKehadiran[index].jam = jam || "-";
      }

      // Update keterangan
      function updateKeterangan(index, keterangan) {
        dataKehadiran[index].keterangan = keterangan || "-";
      }

      // Update summary
      function updateSummary() {
        const hadir = dataKehadiran.filter((s) => s.status === "Hadir").length;
        const izin = dataKehadiran.filter((s) => s.status === "Izin").length;
        const sakit = dataKehadiran.filter((s) => s.status === "Sakit").length;
        const alpha = dataKehadiran.filter((s) => s.status === "Alpha").length;

        document.getElementById("totalHadir").textContent = hadir;
        document.getElementById("totalIzin").textContent = izin;
        document.getElementById("totalSakit").textContent = sakit;
        document.getElementById("totalAlpha").textContent = alpha;
      }

      // Search siswa
      document
        .getElementById("searchSiswa")
        .addEventListener("input", function (e) {
          const search = e.target.value.toLowerCase();
          filteredData = dataKehadiran.filter(
            (siswa) =>
              siswa.nama.toLowerCase().includes(search) ||
              siswa.nis.includes(search)
          );
          renderTable(filteredData);
        });

      // Simpan kehadiran
      function simpanKehadiran() {
        if (dataKehadiran.length === 0) {
          alert("❌ Tidak ada data kehadiran untuk disimpan!");
          return;
        }

        const kelas = document.getElementById("kelasAbsen").value;
        const mapel = document.getElementById("mataPelajaran").value;
        const jamKe = document.getElementById("jamKe").value;
        const tanggal = document.getElementById("tanggalAbsen").value;

        const hadir = dataKehadiran.filter((s) => s.status === "Hadir").length;
        const total = dataKehadiran.length;

        if (
          confirm(
            `💾 Simpan data kehadiran?\n\nKelas: ${kelas}\nMapel: ${mapel}\nJam: ${jamKe}\nTanggal: ${formatTanggal(
              tanggal
            )}\n\nHadir: ${hadir}/${total} siswa`
          )
        ) {
          // Di sini nanti akan dikirim ke backend
          console.log("Data kehadiran:", {
            kelas,
            mapel,
            jamKe,
            tanggal,
            data: dataKehadiran,
          });

          alert("✅ Data kehadiran berhasil disimpan!");
        }
      }

      // Export to Excel
      function exportToExcel() {
        if (dataKehadiran.length === 0) {
          alert("❌ Tidak ada data untuk di-export!");
          return;
        }
        alert("📊 Fitur export Excel akan segera tersedia...");
      }

      // Cetak kehadiran
      function cetakKehadiran() {
        if (dataKehadiran.length === 0) {
          alert("❌ Tidak ada data untuk dicetak!");
          return;
        }
        window.print();
      }

      // Reset form
      function resetForm() {
        if (
          confirm("🔄 Reset form? Semua data yang belum disimpan akan hilang!")
        ) {
          document.getElementById("kelasAbsen").value = "";
          document.getElementById("mataPelajaran").value = "";
          document.getElementById("jamKe").value = "";
          document.getElementById("searchSiswa").value = "";
          dataKehadiran = [];
          filteredData = [];
          document.getElementById("summarySection").style.display = "none";
          document.getElementById("tableSection").style.display = "none";
        }
      }

      // Initialize
      setTanggalHariIni();
    </script>
  </body>
</html>
